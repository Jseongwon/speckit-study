package main

import (
	"context"
	"fmt"
	"os"
	"path/filepath"
	"time"

	"speckit-study/internal/llm"
)

func main() {
	root := "msaproj" // í•„ìš”ì‹œ ì¸ì/í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜ ê°€ëŠ¥

	// 1) ëª¨ë¸ ë ˆì§€ìŠ¤íŠ¸ë¦¬ êµ¬ì„±
	reg := llm.NewModelRegistry()
	reg.RegisterModel("gpt", llm.NewOpenAIClient())
	reg.RegisterModel("claude", llm.NewAnthropicClient())
	reg.RegisterModel("gemini", llm.NewGeminiClient())
	// optional default:
	reg.RegisterModel("default", llm.NewOpenAIClient())

	// 2) ìƒì„± ëŒ€ìƒê³¼ ëª¨ë¸ ë§¤í•‘
	type target struct {
		RelPath    string
		ModelTag   string
		SeedPrompt string
	}

	targets := []target{
		{
			RelPath:  ".specify/notification-service/plan.md",
			ModelTag: "gemini",
			SeedPrompt: `You are writing a *Development Plan* for "notification-service".
Include milestones and testing strategy like a concise project plan.`,
		},
		{
			RelPath:  ".specify/notification-service/specify.md",
			ModelTag: "gpt",
			SeedPrompt: `Create a *Specification* for "notification-service".
Include Goal, Context, Success Criteria. Keep it practical.`,
		},
		{
			RelPath:    ".specify/notification-service/tasks.yaml",
			ModelTag:   "claude",
			SeedPrompt: `Write a minimal tasks.yaml with one task "basic_test" that includes inputs: service="notification-service" and required_sections: ["Goal","Success Criteria"].`,
		},
	}

	// 3) ê° íŒŒì¼ì„ í•´ë‹¹ ëª¨ë¸ë¡œ ìƒì„±
	ctx := context.Background()
	for _, t := range targets {
		model, ok := reg.GetModel(t.ModelTag)
		if !ok {
			fmt.Printf("âŒ model not registered: %s\n", t.ModelTag)
			os.Exit(1)
		}
		content, err := model.Generate(ctx, t.SeedPrompt)
		if err != nil {
			fmt.Printf("âŒ generation error (%s): %v\n", t.RelPath, err)
			os.Exit(1)
		}
		if err := writeFile(filepath.Join(root, t.RelPath), content); err != nil {
			fmt.Printf("âŒ write error (%s): %v\n", t.RelPath, err)
			os.Exit(1)
		}
		fmt.Printf("âœ… generated by %-7s â†’ %s\n", t.ModelTag, t.RelPath)
	}

	// 4) _runs í´ë”ì— ì‹¤í–‰ ë¡œê·¸ ë‚¨ê¸°ê¸° (íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì¼)
	runsDir := filepath.Join(root, ".specify", "_runs")
	_ = os.MkdirAll(runsDir, 0o755)
	logPath := filepath.Join(runsDir, time.Now().Format("20060102_150405")+"_specgen.log")
	_ = os.WriteFile(logPath, []byte("specgen completed"), 0o644)
	fmt.Printf("ğŸ“ run log: %s\n", logPath)
}

func writeFile(path string, content string) error {
	if err := os.MkdirAll(filepath.Dir(path), 0o755); err != nil {
		return err
	}
	return os.WriteFile(path, []byte(content), 0o644)
}
